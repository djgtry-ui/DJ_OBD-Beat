<!doctype html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beat eSP OBD-II Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-bg { background: radial-gradient(circle at top right, #0f172a, #000000); }
        canvas { max-width: 100%; height: auto; transition: all 0.3s; }
        
        /* Animasi untuk Overlay */
        #connectionOverlay {
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        .pulse-icon { animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="h-full w-full gradient-bg text-gray-200 p-4 flex flex-col items-center overflow-x-hidden">

    <div id="connectionOverlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black/90 backdrop-blur-md p-6 text-center">
        <div class="mb-6 relative">
            <i class="fas fa-satellite-dish text-6xl text-red-500 pulse-icon"></i>
            <i class="fas fa-bluetooth-b text-2xl text-blue-400 absolute -bottom-2 -right-2"></i>
        </div>
        <h2 class="text-2xl font-black text-white mb-2 tracking-tight uppercase">Menunggu Koneksi...</h2>
        <p class="text-gray-400 max-w-xs text-sm leading-relaxed mb-8">
            Pastikan alat <span class="text-red-500 font-bold">ELM327</span> terpasang di motor dan HP Anda terhubung ke WiFi <span class="text-indigo-400 font-bold">Dj_Module_OBD</span>.
        </p>
        <div class="flex gap-4">
            <div class="flex items-center gap-2 text-[10px] text-gray-500 uppercase tracking-widest">
                <i class="fas fa-wifi"></i> WiFi Ready
            </div>
            <div class="flex items-center gap-2 text-[10px] text-gray-500 uppercase tracking-widest">
                <i class="fas fa-microchip"></i> ESP32 Active
            </div>
        </div>
    </div>

    <div class="w-full max-w-4xl flex flex-col items-center">
        <header class="w-full glass p-6 rounded-[30px] mb-6 text-center shadow-2xl">
            <h1 class="text-2xl font-black text-indigo-400 tracking-tighter uppercase italic">
                <i class="fas fa-tachometer-alt mr-2"></i>OBD-II Smart Monitor
            </h1>
            <div class="flex justify-center items-center gap-3 mt-2 text-[10px] font-mono tracking-widest">
                <span id="status" class="text-red-500 animate-pulse">SEARCHING...</span>
                <span class="text-gray-700">|</span>
                <span id="weton" class="text-gray-400 font-bold"></span>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full mb-6">
            <div class="glass p-8 rounded-[40px] flex flex-col items-center relative overflow-hidden">
                <canvas id="rpmGauge" width="240" height="240"></canvas>
                <h2 class="text-5xl font-black -mt-12" id="rpmText">0</h2>
                <p class="text-[10px] uppercase text-indigo-400 font-bold mt-2">RPM (Rotations Per Minute)</p>
            </div>
            <div class="glass p-8 rounded-[40px] flex flex-col items-center">
                <canvas id="speedGauge" width="240" height="240"></canvas>
                <h2 class="text-5xl font-black -mt-12" id="speedText">0</h2>
                <p class="text-[10px] uppercase text-emerald-400 font-bold mt-2">Speed (KM/H)</p>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 w-full mb-6">
            <div class="glass p-4 rounded-2xl text-center">
                <i class="fas fa-car-battery text-yellow-400 text-xs mb-1"></i>
                <p class="text-[9px] uppercase text-gray-500 mb-1">Aki (Voltage)</p>
                <h4 id="vAki" class="text-xl font-black text-yellow-400">0.0V</h4>
            </div>
            <div class="glass p-4 rounded-2xl text-center">
                <i class="fas fa-sliders-h text-indigo-400 text-xs mb-1"></i>
                <p class="text-[9px] uppercase text-gray-500 mb-1">Throttle</p>
                <h4 id="vGas" class="text-xl font-black text-indigo-400">0%</h4>
            </div>
            <div class="glass p-4 rounded-2xl text-center">
                <i class="fas fa-thermometer-half text-red-500 text-xs mb-1"></i>
                <p class="text-[9px] uppercase text-gray-500 mb-1">Engine Temp</p>
                <h4 id="vTemp" class="text-xl font-black text-red-500">0째C</h4>
            </div>
            <div class="glass p-4 rounded-2xl text-center">
                <i class="fas fa-wind text-blue-400 text-xs mb-1"></i>
                <p class="text-[9px] uppercase text-gray-500 mb-1">Intake Temp</p>
                <h4 id="vIat" class="text-xl font-black text-blue-400">0째C</h4>
            </div>
        </div>

        <div class="w-full glass p-6 rounded-[30px] border border-red-500/20 text-center">
            <p class="text-[10px] font-bold text-red-500 mb-3 tracking-widest uppercase">
                <i class="fas fa-exclamation-triangle mr-1"></i>Diagnostic Trouble Codes (DTC)
            </p>
            <div id="dtcConsole" class="bg-black/40 p-4 rounded-xl font-mono text-sm text-green-500 mb-4 border border-white/5">
                No Fault Detected
            </div>
            <button onclick="resetECU()" class="w-full py-4 bg-red-600 hover:bg-red-500 text-white rounded-xl font-black text-sm uppercase tracking-widest transition shadow-lg active:scale-95">
                Clear DTC / Reset ECU
            </button>
        </div>
    </div>

    <script>
        const overlay = document.getElementById('connectionOverlay');

        function drawGauge(id, val, max, color) {
            const ctx = document.getElementById(id).getContext('2d');
            ctx.clearRect(0,0,240,240);
            ctx.beginPath(); ctx.arc(120, 120, 95, 0.8 * Math.PI, 0.2 * Math.PI);
            ctx.strokeStyle = '#111827'; ctx.lineWidth = 16; ctx.lineCap='round'; ctx.stroke();
            let end = 0.8 * Math.PI + (val/max) * (1.4 * Math.PI);
            ctx.beginPath(); ctx.arc(120, 120, 95, 0.8 * Math.PI, end > 2.2*Math.PI ? 2.2*Math.PI : end);
            ctx.strokeStyle = color; ctx.lineWidth = 16; ctx.lineCap='round'; ctx.stroke();
        }

        async function update() {
            try {
                const res = await fetch('http://192.168.4.1/data');
                const d = await res.json();
                
                // Jika sukses, sembunyikan overlay
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.visibility = 'hidden', 500);

                document.getElementById('status').innerText = "ECU CONNECTED";
                document.getElementById('status').className = "text-green-400 animate-none font-bold";

                drawGauge('rpmGauge', d.rpm, 10000, '#6366f1');
                drawGauge('speedGauge', d.speed, 140, '#10b981');
                document.getElementById('rpmText').innerText = Math.round(d.rpm);
                document.getElementById('speedText').innerText = d.speed;
                document.getElementById('vAki').innerText = d.volt.toFixed(1) + "V";
                document.getElementById('vGas').innerText = Math.round(d.throttle) + "%";
                document.getElementById('vTemp').innerText = d.temp + "째C";
                document.getElementById('vIat').innerText = d.iat + "째C";

                const consoleEl = document.getElementById('dtcConsole');
                if(d.dtc && d.dtc !== "Normal") {
                    consoleEl.innerText = "ERROR: " + d.dtc;
                    consoleEl.className = "bg-red-900/20 p-4 rounded-xl font-mono text-sm text-red-500 mb-4 border border-red-500/30";
                } else {
                    consoleEl.innerText = "System Healthy";
                    consoleEl.className = "bg-black/40 p-4 rounded-xl font-mono text-sm text-green-500 mb-4 border border-white/5";
                }
            } catch(e) {
                // Jika gagal, tampilkan overlay
                overlay.style.visibility = 'visible';
                overlay.style.opacity = '1';

                document.getElementById('status').innerText = "OFFLINE";
                document.getElementById('status').className = "text-red-500 animate-pulse";
            }
        }

        async function resetECU() {
            if(!confirm("Hapus kode error dari ECU motor?")) return;
            try {
                const res = await fetch('http://192.168.4.1/reset');
                if(res.ok) alert("DTC Cleared! Cek dashboard lagi.");
            } catch(e) { alert("ESP32 tidak merespon"); }
        }

        function setWeton() {
            const h = new Date().getHours();
            // Sesuaikan dengan data terbaru Anda
            document.getElementById('weton').innerText = (h >= 18) ? "RABU PON" : "SELASA PAHING";
        }

        setInterval(update, 500); // Sedikit diperlambat agar tidak membebani ESP32
        setInterval(setWeton, 1000);
    </script>
</body>
</html>
